name: Cross-Platform Build and Release

on:
  # 标签触发 - 推送 v* 标签时触发构建
  push:
    tags: ['v*.*.*']
    
  # 手动触发 - 作为备用选项
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号（例如: 1.0.0）'
        required: true
        type: string
        default: '1.0.0'
      skip_release:
        description: '跳过自动发布到 GitHub Releases'
        required: false
        type: boolean
        default: false

# 并发控制 - 避免同时运行多个构建
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# 环境变量
env:
  PYTHON_VERSION: '3.11'

jobs:
  # 跨平台构建作业
  build:
    strategy:
      fail-fast: false  # 一个平台失败不影响其他平台
      matrix:
        include:
          # Ubuntu - 构建 Linux 版本
          - os: ubuntu-latest
            platform: linux
            build_script: packaging/linux/build_linux.sh
            artifact_pattern: "releases/v*/md2docx-v*-Linux.*"
            
          # Windows - 构建 Windows 版本  
          - os: windows-latest
            platform: windows
            build_script: packaging\windows\build_windows.bat
            artifact_pattern: "packaging/windows/dist/md2docx-v*-windows.zip"
            
          # macOS Intel - 构建 macOS Intel 版本
          - os: macos-12
            platform: macos
            arch: intel
            build_script: packaging/macos/build_macos.sh
            artifact_pattern: "releases/v*/md2docx-v*-macOS-intel.*"
            
          # macOS Apple Silicon - 构建 macOS Apple Silicon 版本  
          - os: macos-latest
            platform: macos
            arch: silicon
            build_script: packaging/macos/build_macos.sh
            artifact_pattern: "releases/v*/md2docx-v*-macOS-silicon.*"
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install base dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        
    # Ubuntu 特定设置
    - name: Install Linux dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc fuse
        pip install pyinstaller
        
        # 下载 AppImage 工具
        wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool
        sudo mv appimagetool /usr/local/bin/
        
    # Windows 特定设置
    - name: Install Windows dependencies
      if: matrix.platform == 'windows'
      run: |
        choco install pandoc -y
        pip install pyinstaller
        
    # macOS 特定设置  
    - name: Install macOS dependencies
      if: matrix.platform == 'macos'
      run: |
        brew install pandoc create-dmg
        pip install py2app
        
    - name: Build Windows application
      env:
        BUILD_ARCH: ${{ matrix.arch || '' }}
      if: matrix.platform == 'windows'
      run: |
        cmd.exe /c "${{ matrix.build_script }}"

    - name: Build Linux or macOS application
      env:
        BUILD_ARCH: ${{ matrix.arch || '' }}
      if: matrix.platform == 'macos' || matrix.platform == 'linux'
      run: |
        chmod +x ${{ matrix.build_script }}
        ${{ matrix.build_script }}
        
    - name: Verify build artifacts
      shell: bash
      run: |
        # 从项目根目录的VERSION文件读取版本号
        VERSION=$(cat VERSION)
        echo "🔍 Checking build artifacts for version $VERSION..."
        ls -la releases/v$VERSION/ || true
        
        # 验证关键文件存在
        if [[ "${{ matrix.platform }}" == "linux" ]]; then
          # 检查Linux tar.gz文件或目录
          if ls releases/v$VERSION/md2docx-v$VERSION-Linux.tar.gz 1> /dev/null 2>&1; then
            echo "✅ Found Linux tar.gz file"
          elif ls releases/v$VERSION/md2docx-v$VERSION-Linux/ 1> /dev/null 2>&1; then
            echo "✅ Found Linux directory"
          else
            echo "❌ Linux build artifacts not found, checking what files exist..."
            ls -la releases/v$VERSION/ 2>/dev/null || echo "Release directory does not exist or is empty"
            echo "Contents of entire releases directory:"
            find releases/ -type f 2>/dev/null || echo "No files found in releases directory"
            echo "Checking if dist directory exists:"
            if [[ -d packaging/linux/dist ]]; then
              echo "Linux dist directory exists:"
              ls -la packaging/linux/dist/
            else
              echo "Linux dist directory does not exist"
            fi
            exit 1
          fi
        elif [[ "${{ matrix.platform }}" == "windows" ]]; then
          # 增强Windows验证逻辑，提供更多调试信息
          echo "Checking for Windows ZIP file..."
          if ls packaging/windows/dist/md2docx-v$VERSION-windows.zip 1> /dev/null 2>&1; then
            echo "✅ Found Windows ZIP file in packaging/windows/dist/"
          elif ls releases/v$VERSION/md2docx-v$VERSION-Windows.zip 1> /dev/null 2>&1; then
            echo "✅ Found Windows ZIP file in releases/"
          elif ls releases/v$VERSION/md2docx-v$VERSION-Windows/ 1> /dev/null 2>&1; then
            echo "✅ Found Windows directory"
          else
            echo "❌ Windows build artifacts not found, checking what files exist..."
            echo "Contents of packaging/windows/dist:"
            ls -la packaging/windows/dist/ 2>/dev/null || echo "packaging/windows/dist directory does not exist"
            echo "Contents of releases/v$VERSION/:"
            ls -la releases/v$VERSION/ 2>/dev/null || echo "Release directory does not exist or is empty"
            echo "Contents of entire releases directory:"
            find releases/ -type f 2>/dev/null || echo "No files found in releases directory"
            exit 1
          fi
        elif [[ "${{ matrix.platform }}" == "macos" ]]; then
          if [[ -n "${{ matrix.arch }}" ]]; then
            ls releases/v$VERSION/md2docx-v$VERSION-macOS-${{ matrix.arch }}.dmg || \
            ls releases/v$VERSION/md2docx-v$VERSION-macOS-${{ matrix.arch }}/
          else
            ls releases/v$VERSION/md2docx-v$VERSION-macOS.dmg || \
            ls releases/v$VERSION/md2docx-v$VERSION-macOS/
          fi
        fi
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}${{ matrix.arch && format('-{0}', matrix.arch) || '' }}-build
        path: ${{ matrix.artifact_pattern }}
        if-no-files-found: error
        retention-days: 30
        
    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}${{ matrix.arch && format('-{0}', matrix.arch) || '' }}-checksums
        path: releases/v*/checksums.txt
        if-no-files-found: warn

  # 发布作业 - 收集所有构建产物并创建 Release
  release:
    needs: build
    if: ${{ !inputs.skip_release }}
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # 需要写权限来创建 Release
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: Organize release files
      run: |
        mkdir -p ./release-files
        
        # 复制构建产物
        find ./artifacts -name "md2docx-v*.*" -type f -exec cp {} ./release-files/ \;
        
        # 合并校验和文件
        echo "# SHA256 Checksums - md2docx" > ./release-files/checksums.txt
        echo "# Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ./release-files/checksums.txt
        echo "" >> ./release-files/checksums.txt
        
        find ./artifacts -name "checksums.txt" -exec cat {} \; | grep -v "^#" | sort >> ./release-files/checksums.txt || true
        
        echo "📦 Release files prepared:"
        ls -la ./release-files/
        
    - name: Generate release notes
      run: |
        # 从项目根目录的VERSION文件读取版本号
        VERSION=$(cat VERSION)
        cat > ./release-notes.md << 'EOF'
        # md2docx v'"$VERSION"'
        
        🎉 跨平台 Markdown 到 Word 文档转换工具新版本发布！
        
        ## 📦 下载
        
        | 平台 | 文件 | 说明 |
        |------|------|------|
        | 🍎 **macOS Intel** | `md2docx-v'"$VERSION"'-macOS-intel.dmg` | Intel Mac (macOS 10.15+) |
        | 🍎 **macOS Apple Silicon** | `md2docx-v'"$VERSION"'-macOS-silicon.dmg` | Apple Silicon Mac (macOS 11.0+) |
        | 🪟 **Windows** | `md2docx-v'"$VERSION"'-Windows.zip` | Windows 10+ |
        | 🐧 **Linux** | `md2docx-v'"$VERSION"'-Linux.tar.gz` | 大部分发行版 |
        | 🐧 **Linux** | `md2docx-v'"$VERSION"'-x86_64.AppImage` | 便携版本 |
        
        ### 🔍 如何选择 macOS 版本？
        
        **查看您的 Mac 架构**：
        - 点击苹果菜单 > 关于本机
        - 查看 "芯片" 或 "处理器" 信息：
          - **Apple M1/M2/M3** 系列 → 下载 `silicon` 版本
          - **Intel** 处理器 → 下载 `intel` 版本
        
        ## 🔐 文件验证
        
        使用 `checksums.txt` 验证下载文件的完整性：
        ```bash
        sha256sum -c checksums.txt
        ```
        
        ## 📋 系统要求
        
        - **外部依赖**: 需要安装 [Pandoc](https://pandoc.org/installing.html)
        - **内存**: 至少 100MB RAM
        - **存储**: 200MB 磁盘空间
        
        ## 🚀 快速开始
        
        1. 下载对应平台的安装包
        2. 安装 Pandoc：
           - macOS: `brew install pandoc`
           - Windows: 从官网下载安装程序
           - Linux: `sudo apt install pandoc`
        3. 运行 md2docx 开始转换文档！
        
        ---
        
        🤖 此版本通过 GitHub Actions 自动构建
        📅 构建时间: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        🔗 完整更新日志: [查看提交记录](https://github.com/${{ github.repository }}/commits/v'"$VERSION"')
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.ref_name }}
        name: "md2docx v${{ github.ref_name }}"
        body_path: ./release-notes.md
        files: ./release-files/*
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') || contains(github.ref, 'dev') }}
        generate_release_notes: true
        make_latest: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') && !contains(github.ref, 'dev') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release summary
      run: |
        # 从项目根目录的VERSION文件读取版本号
        VERSION=$(cat VERSION)
        echo "🎉 Release v$VERSION created successfully!"
        echo "🔗 Release URL: https://github.com/${{ github.repository }}/releases/tag/v$VERSION"
        echo ""
        echo "📦 Files released:"
        ls -la ./release-files/