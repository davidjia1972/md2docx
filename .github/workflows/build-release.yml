name: Cross-Platform Build and Release

on:
  # æ ‡ç­¾è§¦å‘ - æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘æ„å»º
  push:
    tags: ['v*.*.*']
    
  # æ‰‹åŠ¨è§¦å‘ - ä½œä¸ºå¤‡ç”¨é€‰é¡¹
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚: 1.0.0ï¼‰'
        required: true
        type: string
        default: '1.0.0'
      skip_release:
        description: 'è·³è¿‡è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releases'
        required: false
        type: boolean
        default: false

# å¹¶å‘æ§åˆ¶ - é¿å…åŒæ—¶è¿è¡Œå¤šä¸ªæ„å»º
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'

jobs:
  # é¢„å¤„ç†ä½œä¸š - è·å–ç‰ˆæœ¬ä¿¡æ¯
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Extract version information
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/v}
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
        if [[ "$VERSION" =~ (alpha|beta|rc|dev) ]]; then
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi
        
        echo "ğŸ”– Version: $VERSION"
        echo "ğŸš€ Is prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') || contains(github.ref, 'dev') }}"

  # è·¨å¹³å°æ„å»ºä½œä¸š
  build:
    needs: prepare
    strategy:
      fail-fast: false  # ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°
      matrix:
        include:
          # Ubuntu - æ„å»º Linux ç‰ˆæœ¬
          - os: ubuntu-latest
            platform: linux
            build_script: packaging/linux/build_linux.sh
            artifact_pattern: "releases/v*/md2docx-v*-Linux.*"
            
          # Windows - æ„å»º Windows ç‰ˆæœ¬  
          - os: windows-latest
            platform: windows
            build_script: packaging/windows/build_windows.bat
            artifact_pattern: "releases/v*/md2docx-v*-Windows.*"
            
          # macOS Intel - æ„å»º macOS Intel ç‰ˆæœ¬
          - os: macos-12
            platform: macos
            arch: x86_64
            build_script: packaging/macos/build_macos.sh
            artifact_pattern: "releases/v*/md2docx-v*-macOS-x86_64.*"
            
          # macOS Apple Silicon - æ„å»º macOS Apple Silicon ç‰ˆæœ¬  
          - os: macos-latest
            platform: macos
            arch: arm64
            build_script: packaging/macos/build_macos.sh
            artifact_pattern: "releases/v*/md2docx-v*-macOS-arm64.*"
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install base dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        
    # Ubuntu ç‰¹å®šè®¾ç½®
    - name: Install Linux dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc fuse
        pip install pyinstaller
        
        # ä¸‹è½½ AppImage å·¥å…·
        wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool
        sudo mv appimagetool /usr/local/bin/
        
    # Windows ç‰¹å®šè®¾ç½®
    - name: Install Windows dependencies
      if: matrix.platform == 'windows'
      run: |
        choco install pandoc -y
        pip install pyinstaller
        
    # macOS ç‰¹å®šè®¾ç½®  
    - name: Install macOS dependencies
      if: matrix.platform == 'macos'
      run: |
        brew install pandoc create-dmg
        pip install py2app
        
    - name: Update VERSION file
      run: |
        echo "${{ needs.prepare.outputs.version }}" > VERSION
        
    - name: Build application
      shell: bash
      env:
        BUILD_ARCH: ${{ matrix.arch || '' }}
      run: |
        # è®¾ç½®æ‰§è¡Œæƒé™
        if [[ "${{ matrix.platform }}" != "windows" ]]; then
          chmod +x ${{ matrix.build_script }}
        fi
        
        # æ‰§è¡Œæ„å»ºè„šæœ¬
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          # Windowså¹³å°ä½¿ç”¨cmdæ‰§è¡Œ.batæ–‡ä»¶
          cmd.exe /c "${{ matrix.build_script }}"
        else
          bash ${{ matrix.build_script }}
        fi
        
    - name: Verify build artifacts
      shell: bash
      run: |
        echo "ğŸ” Checking build artifacts..."
        ls -la releases/v${{ needs.prepare.outputs.version }}/ || true
        
        # éªŒè¯å…³é”®æ–‡ä»¶å­˜åœ¨
        if [[ "${{ matrix.platform }}" == "linux" ]]; then
          # ä¿®å¤LinuxéªŒè¯é€»è¾‘ï¼Œæ£€æŸ¥æ­£ç¡®çš„æ–‡ä»¶å
          ls releases/v${{ needs.prepare.outputs.version }}/md2docx-v${{ needs.prepare.outputs.version }}-Linux.tar.gz || \
          ls releases/v${{ needs.prepare.outputs.version }}/md2docx-v${{ needs.prepare.outputs.version }}-Linux/
        elif [[ "${{ matrix.platform }}" == "windows" ]]; then
          # å¢å¼ºWindowséªŒè¯é€»è¾‘ï¼Œæä¾›æ›´å¤šè°ƒè¯•ä¿¡æ¯
          echo "Checking for Windows ZIP file..."
          if ls releases/v${{ needs.prepare.outputs.version }}/md2docx-v${{ needs.prepare.outputs.version }}-Windows.zip 1> /dev/null 2>&1; then
            echo "âœ… Found Windows ZIP file"
          else
            echo "âŒ Windows ZIP file not found, checking what files exist..."
            ls -la releases/v${{ needs.prepare.outputs.version }}/ 2>/dev/null || echo "Release directory does not exist or is empty"
            echo "Contents of entire releases directory:"
            find releases/ -type f 2>/dev/null || echo "No files found in releases directory"
            echo "Checking if dist directory exists:"
            if [[ -d packaging/windows/dist ]]; then
              echo "Windows dist directory exists:"
              ls -la packaging/windows/dist/
            else
              echo "Windows dist directory does not exist"
            fi
            exit 1
          fi
        elif [[ "${{ matrix.platform }}" == "macos" ]]; then
          if [[ -n "${{ matrix.arch }}" ]]; then
            ls releases/v${{ needs.prepare.outputs.version }}/md2docx-v${{ needs.prepare.outputs.version }}-macOS-${{ matrix.arch }}.dmg || \
            ls releases/v${{ needs.prepare.outputs.version }}/md2docx-v${{ needs.prepare.outputs.version }}-macOS-${{ matrix.arch }}/
          else
            ls releases/v${{ needs.prepare.outputs.version }}/md2docx-v${{ needs.prepare.outputs.version }}-macOS.dmg || \
            ls releases/v${{ needs.prepare.outputs.version }}/md2docx-v${{ needs.prepare.outputs.version }}-macOS/
          fi
        fi
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}${{ matrix.arch && format('-{0}', matrix.arch) || '' }}-build
        path: ${{ matrix.artifact_pattern }}
        if-no-files-found: error
        retention-days: 30
        
    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}${{ matrix.arch && format('-{0}', matrix.arch) || '' }}-checksums
        path: releases/v${{ needs.prepare.outputs.version }}/checksums.txt
        if-no-files-found: warn

  # å‘å¸ƒä½œä¸š - æ”¶é›†æ‰€æœ‰æ„å»ºäº§ç‰©å¹¶åˆ›å»º Release
  release:
    needs: [prepare, build]
    if: ${{ !inputs.skip_release }}
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: Organize release files
      run: |
        mkdir -p ./release-files
        
        # å¤åˆ¶æ„å»ºäº§ç‰©
        find ./artifacts -name "md2docx-v*.*" -type f -exec cp {} ./release-files/ \;
        
        # åˆå¹¶æ ¡éªŒå’Œæ–‡ä»¶
        echo "# SHA256 Checksums - md2docx v${{ needs.prepare.outputs.version }}" > ./release-files/checksums.txt
        echo "# Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ./release-files/checksums.txt
        echo "" >> ./release-files/checksums.txt
        
        find ./artifacts -name "checksums.txt" -exec cat {} \; | grep -v "^#" | sort >> ./release-files/checksums.txt || true
        
        echo "ğŸ“¦ Release files prepared:"
        ls -la ./release-files/
        
    - name: Generate release notes
      run: |
        cat > ./release-notes.md << 'EOF'
        # md2docx v${{ needs.prepare.outputs.version }}
        
        ğŸ‰ è·¨å¹³å° Markdown åˆ° Word æ–‡æ¡£è½¬æ¢å·¥å…·æ–°ç‰ˆæœ¬å‘å¸ƒï¼
        
        ## ğŸ“¦ ä¸‹è½½
        
        | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
        |------|------|------|
        | ğŸ **macOS Intel** | `md2docx-v${{ needs.prepare.outputs.version }}-macOS-x86_64.dmg` | Intel Mac (macOS 10.15+) |
        | ğŸ **macOS Apple Silicon** | `md2docx-v${{ needs.prepare.outputs.version }}-macOS-arm64.dmg` | Apple Silicon Mac (macOS 11.0+) |
        | ğŸªŸ **Windows** | `md2docx-v${{ needs.prepare.outputs.version }}-Windows.zip` | Windows 10+ |
        | ğŸ§ **Linux** | `md2docx-v${{ needs.prepare.outputs.version }}-Linux.tar.gz` | å¤§éƒ¨åˆ†å‘è¡Œç‰ˆ |
        | ğŸ§ **Linux** | `md2docx-v${{ needs.prepare.outputs.version }}-x86_64.AppImage` | ä¾¿æºç‰ˆæœ¬ |
        
        ### ğŸ” å¦‚ä½•é€‰æ‹© macOS ç‰ˆæœ¬ï¼Ÿ
        
        **æŸ¥çœ‹æ‚¨çš„ Mac æ¶æ„**ï¼š
        - ç‚¹å‡»è‹¹æœèœå• > å…³äºæœ¬æœº
        - æŸ¥çœ‹ "èŠ¯ç‰‡" æˆ– "å¤„ç†å™¨" ä¿¡æ¯ï¼š
          - **Apple M1/M2/M3** ç³»åˆ— â†’ ä¸‹è½½ `arm64` ç‰ˆæœ¬
          - **Intel** å¤„ç†å™¨ â†’ ä¸‹è½½ `x86_64` ç‰ˆæœ¬
        
        ## ğŸ” æ–‡ä»¶éªŒè¯
        
        ä½¿ç”¨ `checksums.txt` éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š
        ```bash
        sha256sum -c checksums.txt
        ```
        
        ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
        
        - **å¤–éƒ¨ä¾èµ–**: éœ€è¦å®‰è£… [Pandoc](https://pandoc.org/installing.html)
        - **å†…å­˜**: è‡³å°‘ 100MB RAM
        - **å­˜å‚¨**: 200MB ç£ç›˜ç©ºé—´
        
        ## ğŸš€ å¿«é€Ÿå¼€å§‹
        
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
        2. å®‰è£… Pandocï¼š
           - macOS: `brew install pandoc`
           - Windows: ä»å®˜ç½‘ä¸‹è½½å®‰è£…ç¨‹åº
           - Linux: `sudo apt install pandoc`
        3. è¿è¡Œ md2docx å¼€å§‹è½¬æ¢æ–‡æ¡£ï¼
        
        ---
        
        ğŸ¤– æ­¤ç‰ˆæœ¬é€šè¿‡ GitHub Actions è‡ªåŠ¨æ„å»º
        ğŸ“… æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        ğŸ”— å®Œæ•´æ›´æ–°æ—¥å¿—: [æŸ¥çœ‹æäº¤è®°å½•](https://github.com/${{ github.repository }}/commits/v${{ needs.prepare.outputs.version }})
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.prepare.outputs.version }}
        name: "md2docx v${{ needs.prepare.outputs.version }}"
        body_path: ./release-notes.md
        files: ./release-files/*
        prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
        generate_release_notes: true
        make_latest: ${{ needs.prepare.outputs.is_prerelease == 'false' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release summary
      run: |
        echo "ğŸ‰ Release v${{ needs.prepare.outputs.version }} created successfully!"
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }}"
        echo ""
        echo "ğŸ“¦ Files released:"
        ls -la ./release-files/